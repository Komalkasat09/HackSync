<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Generator Test</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        h1 { color: #3498db; margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="file"] { margin-bottom: 16px; }
        button { background: #3498db; color: #fff; border: none; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:disabled { background: #bdc3c7; }
        .result { margin-top: 32px; }
        .loading { color: #f39c12; }
        .error { color: #e74c3c; }
        .success { color: #27ae60; }
        .meta { margin-top: 16px; background: #ecf0f1; padding: 12px; border-radius: 6px; }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Portfolio Generator</h1>
        <form id="uploadForm">
            <label for="resume">Upload Resume (TXT or PDF):</label>
            <input type="file" id="resume" name="resume" accept=".txt,.pdf" required />
            <button type="submit">Generate Portfolio</button>
        </form>
        <div class="result" id="result"></div>
    </div>
    <script>
        const form = document.getElementById('uploadForm');
        const resultDiv = document.getElementById('result');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            resultDiv.innerHTML = '<span class="loading">Uploading and processing...</span>';
            const fileInput = document.getElementById('resume');
            if (!fileInput.files.length) return;
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('resume', file);

            try {
                // Start generation
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (!data.job_id) throw new Error('No job ID returned');
                resultDiv.innerHTML = '<span class="loading">Job started. Waiting for completion...</span>';
                pollStatus(data.job_id);
            } catch (err) {
                resultDiv.innerHTML = `<span class="error">Error: ${err.message}</span>`;
            }
        });

        async function pollStatus(jobId) {
            let attempts = 0;
            let maxAttempts = 60;
            let delay = 2000;
            while (attempts < maxAttempts) {
                try {
                    const res = await fetch(`/api/portfolio/${jobId}`);
                    if (res.status === 202) {
                        resultDiv.innerHTML = '<span class="loading">Processing... Please wait.</span>';
                    } else if (res.status === 200) {
                        const data = await res.json();
                        showResult(data);
                        return;
                    } else {
                        const err = await res.text();
                        resultDiv.innerHTML = `<span class="error">${err}</span>`;
                        return;
                    }
                } catch (err) {
                    resultDiv.innerHTML = `<span class="error">Error: ${err.message}</span>`;
                    return;
                }
                await new Promise(r => setTimeout(r, delay));
                attempts++;
            }
            resultDiv.innerHTML = '<span class="error">Timeout waiting for portfolio generation.</span>';
        }

        function showResult(data) {
            let html = '';
            if (data.portfolio_url) {
                html += `<div class="success">Portfolio generated!</div>`;
                html += `<a href="${data.portfolio_url}" target="_blank">View Portfolio HTML</a><br/>`;
            }
            if (data.skill_graph) {
                html += `<div class="meta"><strong>Skill Graph JSON:</strong><br/><pre>${JSON.stringify(data.skill_graph, null, 2)}</pre></div>`;
            }
            if (data.metadata) {
                html += `<div class="meta"><strong>Profile Metadata:</strong><br/><pre>${JSON.stringify(data.metadata, null, 2)}</pre></div>`;
            }
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>
